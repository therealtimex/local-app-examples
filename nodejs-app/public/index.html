<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealtimeX SDK Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry {
            font-size: 11px;
            line-height: 1.4;
        }

        .tab-btn {
            transition: all 0.2s;
        }

        .tab-btn.active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stream-output {
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b shadow-sm px-8 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <div
                class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-800">RealtimeX SDK Demo</h1>
                <p class="text-xs text-gray-500">v1.1.0 - All SDK Features</p>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right">
                <div id="app-name" class="text-sm font-medium text-gray-700">Loading...</div>
                <div id="app-id" class="text-xs text-gray-500">ID: Loading...</div>
            </div>
        </div>
    </header>

    <!-- Tabs Navigation -->
    <nav class="bg-white border-b px-8">
        <div class="flex gap-8">
            <button onclick="switchTab('activities')" class="tab-btn active px-4 py-4 text-sm" data-tab="activities">
                üìã Activities
            </button>
            <button onclick="switchTab('api')" class="tab-btn px-4 py-4 text-sm" data-tab="api">
                üîó API & Webhook
            </button>
            <button onclick="switchTab('llm')" class="tab-btn px-4 py-4 text-sm" data-tab="llm">
                ü§ñ LLM & Vectors
            </button>
            <button onclick="switchTab('tts')" class="tab-btn px-4 py-4 text-sm" data-tab="tts">
                üîä TTS
            </button>
            <button onclick="switchTab('stt')" class="tab-btn px-4 py-4 text-sm" data-tab="stt">
                üé§ STT
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="p-8 flex gap-6">
        <!-- LEFT: Tab Content -->
        <div class="flex-1 min-w-0">

            <!-- ==================== ACTIVITIES TAB ==================== -->
            <div id="tab-activities" class="tab-content active space-y-6">
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h2 class="text-lg font-bold text-blue-600 mb-4">üìã Activities CRUD</h2>

                    <!-- Quick Insert -->
                    <div class="flex gap-2 mb-4">
                        <input id="new-activity-data" type="text" value='{"type": "task", "message": "hello"}'
                            class="flex-1 px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                        <button onclick="insertActivity()"
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm">Insert</button>
                    </div>

                    <!-- Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left font-medium text-gray-600">ID</th>
                                    <th class="px-4 py-3 text-left font-medium text-gray-600">Type</th>
                                    <th class="px-4 py-3 text-left font-medium text-gray-600">Status</th>
                                    <th class="px-4 py-3 text-left font-medium text-gray-600">Created</th>
                                    <th class="px-4 py-3 text-left font-medium text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="activities-table" class="divide-y">
                                <tr>
                                    <td colspan="5" class="px-4 py-8 text-center text-gray-400">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button onclick="refreshActivities()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50 text-sm">Refresh</button>
                    </div>
                </div>
            </div>

            <!-- ==================== API & WEBHOOK TAB ==================== -->
            <div id="tab-api" class="tab-content space-y-6">
                <!-- Agents & Workspaces -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h3 class="text-md font-bold text-blue-600 mb-4">ü§ñ Agents</h3>
                        <button onclick="fetchAgents()"
                            class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm mb-3">Fetch
                            Agents</button>
                        <select id="agent-select" class="w-full px-4 py-2 border rounded-lg text-sm">
                            <option value="">Select an agent...</option>
                        </select>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h3 class="text-md font-bold text-blue-600 mb-4">üìÅ Workspaces</h3>
                        <button onclick="fetchWorkspaces()"
                            class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm mb-3">Fetch
                            Workspaces</button>
                        <select id="workspace-select" onchange="fetchThreads()"
                            class="w-full px-4 py-2 border rounded-lg text-sm mb-2">
                            <option value="">Select a workspace...</option>
                        </select>
                        <select id="thread-select" class="w-full px-4 py-2 border rounded-lg text-sm">
                            <option value="create_new">‚ûï Create New Thread</option>
                        </select>
                    </div>
                </div>

                <!-- Trigger Agent -->
                <div class="bg-white rounded-xl shadow-sm border-2 border-blue-500 p-6">
                    <h3 class="text-md font-bold text-blue-600 mb-4">‚ö° Trigger Agent</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Raw Data (JSON)</label>
                            <textarea id="raw-data-input" rows="3"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono">{"type": "task", "message": "hello"}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Prompt</label>
                            <textarea id="prompt-input" rows="3"
                                class="w-full px-4 py-2 border rounded-lg text-sm">Please process this activity.</textarea>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 mt-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="auto-run-toggle" checked class="w-4 h-4">
                            <span class="text-sm">Auto-run (immediate)</span>
                        </label>
                        <button onclick="triggerAgent()"
                            class="flex-1 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-bold">
                            ‚ö° TRIGGER AGENT
                        </button>
                    </div>
                </div>

                <!-- Task Status -->
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h3 class="text-md font-bold text-purple-600 mb-4">üìä Task Status</h3>
                    <div class="flex gap-2">
                        <input type="text" id="task-uuid-input" placeholder="Enter task UUID..."
                            class="flex-1 px-4 py-2 border rounded-lg text-sm font-mono">
                        <button onclick="fetchTaskStatus()"
                            class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">Fetch</button>
                    </div>
                    <div id="task-status-result" class="hidden mt-3 p-3 bg-gray-50 rounded-lg text-sm">
                        <div class="grid grid-cols-2 gap-2">
                            <span class="text-gray-500">Status:</span><span id="task-status-value"
                                class="font-medium">-</span>
                            <span class="text-gray-500">Source:</span><span id="task-source-value"
                                class="font-medium">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== LLM & VECTORS TAB ==================== -->
            <div id="tab-llm" class="tab-content space-y-6">
                <!-- Selectors & Configuration -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h3 class="text-md font-bold text-green-600 mb-4">üîå Model Configuration</h3>
                        <button onclick="fetchProviders()"
                            class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm mb-4">Fetch
                            Available Models</button>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Chat
                                    Model</label>
                                <select id="chat-model-select"
                                    class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50">
                                    <option value="">Auto-select (Default)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Embedding
                                    Model</label>
                                <select id="embed-model-select"
                                    class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50">
                                    <option value="">Auto-select (Default)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Section -->
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h3 class="text-md font-bold text-blue-600 mb-4">ÔøΩ Chat Test</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="chat-stream" class="w-4 h-4" checked>
                                    <span class="text-xs font-medium">Use Streaming (SSE)</span>
                                </label>
                                <button onclick="sendChat()"
                                    class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm font-bold">SEND</button>
                            </div>
                            <textarea id="chat-messages" rows="3"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono"
                                placeholder='[{"role":"user","content":"Hello!"}]'>[{"role":"user","content":"Hello! Who are you?"}]</textarea>
                            <div id="chat-response"
                                class="p-3 bg-gray-900 text-green-400 rounded-lg text-sm stream-output max-h-48 overflow-auto border-l-4 border-blue-500 hidden italic">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RAG & Vectors Section -->
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h3 class="text-md font-bold text-orange-600 mb-2">üì¶ Vector Store & RAG (Retrieval-Augmented
                        Generation)</h3>
                    <p class="text-[10px] text-gray-500 mb-6 uppercase tracking-wider font-semibold">Follow these steps
                        to test semantic search capabilities</p>

                    <div class="flex items-center gap-4 mb-6">
                        <div class="flex-1">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Workspace ID
                                (Optional)</label>
                            <input id="vector-workspace-id" type="text" placeholder="Isolated namespace"
                                list="workspace-list"
                                class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition-colors shadow-inner">
                            <datalist id="workspace-list"></datalist>
                        </div>
                        <div class="pt-4">
                            <button onclick="deleteAllVectors()"
                                class="px-3 py-2 text-xs text-red-500 hover:bg-red-50 rounded border border-red-200">Clear
                                Vectors</button>
                        </div>
                    </div>

                    <div class="flex border-b mb-6">
                        <button onclick="showVectorPanel('discovery')"
                            class="v-tab-btn active px-4 py-2 text-sm border-b-2 border-orange-500 text-orange-600 font-bold"
                            data-vtab="discovery">0. DB Discovery</button>
                        <button onclick="showVectorPanel('embed-store')"
                            class="v-tab-btn px-4 py-2 text-sm text-gray-400" data-vtab="embed-store">1. Ingest
                            Data</button>
                        <button onclick="showVectorPanel('search')" class="v-tab-btn px-4 py-2 text-sm text-gray-400"
                            data-vtab="search">2. Search Test</button>
                        <button onclick="showVectorPanel('embed-only')"
                            class="v-tab-btn px-4 py-2 text-sm text-gray-400" data-vtab="embed-only">3. Raw
                            Embedding</button>
                    </div>

                    <!-- Discovery & Registration (Step 0) -->
                    <div id="vector-discovery" class="vector-panel space-y-4">
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4">
                            <p class="text-xs text-gray-800"><strong>Step 0: Discovery & Registration.</strong>
                                Find supported vector databases and register specific storage for this app.</p>
                        </div>

                        <!-- Current DB Config -->
                        <div id="current-vector-db"
                            class="hidden mb-6 p-4 bg-blue-50 border border-blue-100 rounded-xl">
                            <h4 class="text-xs font-bold text-blue-600 uppercase mb-2 flex items-center gap-2">
                                <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
                                Active Vector Database
                            </h4>
                            <div class="flex justify-between items-start">
                                <div>
                                    <p id="current-db-name"
                                        class="text-sm font-bold text-gray-800 uppercase tracking-tight">-</p>
                                    <p id="current-db-details"
                                        class="text-[10px] text-gray-500 font-mono mt-1 break-all"></p>
                                </div>
                                <button onclick="listVectorProviders()"
                                    class="text-[10px] font-bold text-blue-500 hover:underline">Change</button>
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="listVectorProviders()"
                                class="flex-1 py-2 bg-gray-800 text-white rounded-lg hover:bg-black font-bold uppercase text-xs">List
                                Vector Providers</button>
                        </div>
                        <div id="vector-providers-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Providers inject here -->
                        </div>

                        <!-- Registration Form -->
                        <div id="registration-form"
                            class="hidden mt-6 p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white">
                            <h4 class="text-sm font-bold mb-4 flex items-center gap-2">
                                <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                                Register <span id="reg-provider-name" class="text-blue-600"></span>
                            </h4>
                            <div id="reg-fields" class="space-y-3"></div>
                            <button onclick="registerVectorConfig()"
                                class="mt-4 w-full py-2 bg-blue-600 text-white rounded-lg font-bold text-xs uppercase">Save
                                Configuration</button>
                        </div>
                    </div>

                    <!-- Ingest Data (Step 1) -->
                    <div id="vector-embed-store" class="vector-panel space-y-4 hidden">
                        <div class="bg-orange-50 p-3 rounded-lg border border-orange-100 mb-4">
                            <p class="text-xs text-orange-800"><strong>Step 1: Ingest Data.</strong> Prepare your
                                knowledge base. The SDK will automatically chunk your text and store them as vectors.
                                This is where your AI "learns" new info.</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Namespace / Doc
                                    ID</label>
                                <input id="embed-store-doc-id" type="text" placeholder="e.g. documentation-v1"
                                    class="w-full px-4 py-2 border rounded-lg text-sm">
                            </div>
                            <div class="flex items-end">
                                <button onclick="embedAndStore()"
                                    class="w-full py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-bold uppercase text-xs tracking-wider">Start
                                    Ingestion</button>
                            </div>
                        </div>
                        <textarea id="embed-store-texts" rows="4"
                            class="w-full px-4 py-2 border rounded-lg text-sm font-mono"
                            placeholder="Enter texts (one per line)...">RealtimeX is a local AI platform.
It uses Local Apps for extensibility.
SDK v1.1.0 supports vector RAG.</textarea>
                    </div>

                    <!-- Search Test (Step 2) -->
                    <div id="vector-search" class="vector-panel space-y-4 hidden">
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 mb-4">
                            <p class="text-xs text-blue-800"><strong>Step 2: Search Test.</strong> Query your data. You
                                can optionally filter by <strong>Document ID</strong> to search within a specific file.
                            </p>
                        </div>
                        <div class="grid grid-cols-12 gap-2 items-end">
                            <div class="col-span-12 md:col-span-5">
                                <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Query</label>
                                <input id="search-query" type="text" placeholder="Enter question..."
                                    class="w-full px-4 py-2 border rounded-lg text-sm shadow-inner"
                                    value="What can you do?">
                            </div>
                            <div class="col-span-6 md:col-span-4">
                                <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Filter by
                                    Document ID (Optional)</label>
                                <input id="search-doc-id" type="text" placeholder="e.g. doc-1"
                                    class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50">
                            </div>
                            <div class="col-span-3 md:col-span-1">
                                <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Top K</label>
                                <input id="search-topk" type="number" class="w-full px-4 py-2 border rounded-lg text-sm"
                                    value="3">
                            </div>
                            <div class="col-span-3 md:col-span-2">
                                <button onclick="semanticSearch()"
                                    class="w-full py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-bold uppercase text-xs">SEARCH</button>
                            </div>
                        </div>
                        <div id="vector-result" class="grid grid-cols-1 gap-3 hidden">
                            <!-- Results inject here -->
                        </div>
                    </div>

                    <!-- Raw Embedding (Step 3) -->
                    <div id="vector-embed-only" class="vector-panel space-y-4 hidden">
                        <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-4">
                            <p class="text-xs text-indigo-800"><strong>Step 3: Raw Embedding.</strong> See the raw
                                high-dimensional vector data for debugging purposes.</p>
                        </div>
                        <div class="flex gap-2">
                            <input id="embed-input" type="text" class="flex-1 px-4 py-2 border rounded-lg text-sm"
                                value="Sample text for vectorization">
                            <button onclick="generateEmbedding()"
                                class="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 font-bold text-xs">EMBED</button>
                        </div>
                        <div id="embed-result"
                            class="p-3 bg-gray-900 text-indigo-300 border rounded-lg text-xs font-mono hidden overflow-auto max-h-32">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== TTS TAB ==================== -->
            <div id="tab-tts" class="tab-content space-y-6">
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h2 class="text-lg font-bold text-purple-600 mb-4">üîä Text-to-Speech Demo</h2>

                    <!-- Provider Selection -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">TTS Provider</label>
                            <select id="tts-provider-select" onchange="updateTTSConfigUI()"
                                class="w-full px-4 py-2 border rounded-lg text-sm">
                                <option value="">Loading providers...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Voice</label>
                            <select id="tts-voice-select" class="w-full px-4 py-2 border rounded-lg text-sm">
                                <option value="">Default</option>
                            </select>
                        </div>
                    </div>

                    <!-- Config Options (Speed, Language, Quality) -->
                    <div id="tts-config-row" class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Speed</label>
                            <input type="range" id="tts-speed-range" min="0.5" max="2.0" step="0.1" value="1.0"
                                class="w-full"
                                oninput="document.getElementById('tts-speed-value').textContent = this.value">
                            <div class="text-xs text-gray-500 text-center"><span id="tts-speed-value">1.0</span>x</div>
                        </div>
                        <div id="tts-language-container">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Language</label>
                            <select id="tts-language-select" class="w-full px-4 py-2 border rounded-lg text-sm">
                                <option value="en">English</option>
                                <option value="es">Spanish</option>
                                <option value="pt">Portuguese</option>
                                <option value="fr">French</option>
                                <option value="ko">Korean</option>
                            </select>
                        </div>
                        <div id="tts-quality-container">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Quality</label>
                            <input type="range" id="tts-quality-range" min="1" max="20" step="1" value="10"
                                class="w-full"
                                oninput="document.getElementById('tts-quality-value').textContent = this.value">
                            <div class="text-xs text-gray-500 text-center"><span id="tts-quality-value">10</span>/20
                            </div>
                        </div>
                    </div>

                    <!-- Text Input -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Text to Speak</label>
                        <textarea id="tts-text-input" rows="4" class="w-full px-4 py-2 border rounded-lg text-sm"
                            placeholder="Enter text to convert to speech...">Hello! This is a test of the RealtimeX Text-to-Speech SDK. You can use this to generate audio from any text.</textarea>
                    </div>

                    <!-- Generate Buttons -->
                    <div class="flex gap-4 mb-4">
                        <button onclick="generateTTS()"
                            class="flex-1 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold">
                            üé§ Generate Speech
                        </button>
                        <button onclick="generateTTSChunked()"
                            class="flex-1 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold">
                            üìä Stream Chunks
                        </button>
                    </div>

                    <!-- Provider Info -->
                    <div id="tts-provider-info" class="text-xs text-gray-500 mb-4 p-2 bg-gray-50 rounded hidden"></div>

                    <!-- Audio Player -->
                    <div id="tts-audio-container" class="hidden">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Generated Audio</label>
                        <div class="bg-gray-100 rounded-lg p-4">
                            <audio id="tts-audio-player" controls class="w-full">
                                Your browser does not support the audio element.
                            </audio>
                            <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                                <span id="tts-audio-info">-</span>
                                <button onclick="downloadTTSAudio()"
                                    class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                                    üíæ Download
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Chunks Progress -->
                    <div id="tts-chunks-progress" class="hidden mt-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Streaming Progress</label>
                        <div class="bg-gray-100 rounded-lg p-4">
                            <div class="flex justify-between text-xs text-gray-600 mb-2">
                                <span>Chunk <span id="tts-chunk-current">0</span>/<span
                                        id="tts-chunk-total">0</span></span>
                                <span id="tts-chunk-text" class="truncate max-w-xs"></span>
                            </div>
                            <div class="w-full bg-gray-300 rounded-full h-2">
                                <div id="tts-chunks-bar" class="bg-indigo-600 h-2 rounded-full transition-all"
                                    style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Display -->
                    <div id="tts-error"
                        class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                    </div>
                </div>
            </div>
            <!-- ==================== STT TAB ==================== -->
            <div id="tab-stt" class="tab-content space-y-6">
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h2 class="text-lg font-bold text-blue-600 mb-4">üé§ Speech-to-Text Demo</h2>

                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Provider</label>
                                <select id="stt-provider"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="native">Native (Electron)</option>
                                    <option value="whisper">Whisper (Browser - Transformers.js)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Model ID</label>
                                <select id="stt-model"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                    <option value="">Select a model...</option>
                                </select>
                                <button id="stt-refresh-models-btn" onclick="fetchSTTModels()"
                                    class="text-xs text-blue-600 hover:text-blue-800 underline">Refresh Models</button>
                            </div>
                        </div>

                        <button id="stt-listen-btn" onclick="startSTTListening()"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                            üé§ Start Listening
                        </button>

                        <div id="stt-status"
                            class="mt-6 p-4 rounded-lg bg-gray-50 min-h-[100px] border border-gray-200 flex items-center justify-center">
                            <p class="text-gray-400 text-sm italic">Transcript will appear here...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Logs Panel -->
        <div class="w-80 flex-shrink-0">
            <div class="bg-gray-900 rounded-xl shadow-sm p-4 sticky top-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-gray-400">SDK Output</h3>
                    <button onclick="clearLogs()" class="text-xs text-gray-500 hover:text-gray-300">Clear</button>
                </div>
                <div id="logs" class="h-[calc(100vh-200px)] overflow-y-auto text-gray-300 font-mono text-xs space-y-1">
                    <div class="text-gray-500">Initializing...</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ==================== STATE ====================
        let selectedActivity = null;
        let activities = [];

        // ==================== TAB SWITCHING ====================
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        function showVectorPanel(panelId) {
            document.querySelectorAll('.vector-panel').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.v-tab-btn').forEach(b => {
                b.classList.remove('active', 'border-b-2', 'border-orange-500', 'text-orange-600', 'font-bold');
                b.classList.add('text-gray-400');
            });

            document.getElementById(`vector-${panelId}`).classList.remove('hidden');
            const activeBtn = document.querySelector(`[data-vtab="${panelId}"]`);
            activeBtn.classList.add('active', 'border-b-2', 'border-orange-500', 'text-orange-600', 'font-bold');
            activeBtn.classList.remove('text-gray-400');
        }

        // ==================== LOGGING ====================
        function addLog(msg, type = 'info') {
            const now = new Date().toLocaleTimeString('en-US', { hour12: false });
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : ''}`;
            entry.textContent = `[${now}] ${msg}`;
            logs.insertBefore(entry, logs.firstChild);
            if (logs.children.length > 100) logs.removeChild(logs.lastChild);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div class="text-gray-500">Logs cleared</div>';
        }

        // ==================== API HELPER ====================
        async function api(method, path, body = null) {
            const opts = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) opts.body = JSON.stringify(body);
            const res = await fetch(path, opts);
            return res.json();
        }

        // ==================== APP INFO ====================
        async function loadAppInfo() {
            const data = await api('GET', '/api/info');
            document.getElementById('app-name').textContent = `App: ${data.app_name}`;
            document.getElementById('app-id').textContent = `ID: ${data.app_id?.slice(0, 8)}...`;
        }

        // ==================== ACTIVITIES ====================
        async function refreshActivities() {
            addLog('Fetching activities...');
            const data = await api('GET', '/api/activities');
            activities = data.activities || [];
            renderActivities();
            addLog(`Loaded ${activities.length} activities`, 'success');
        }

        function renderActivities() {
            const tbody = document.getElementById('activities-table');
            if (activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">No activities</td></tr>';
                return;
            }
            tbody.innerHTML = activities.map(a => {
                const type = a.raw_data?.type || 'N/A';
                const time = a.created_at?.substring(0, 19).replace('T', ' ') || '';
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-mono text-xs">${a.id.substring(0, 8)}...</td>
                        <td class="px-4 py-3">${type}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs ${a.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-gray-100'}">${a.status || 'pending'}</span></td>
                        <td class="px-4 py-3 text-gray-500">${time}</td>
                        <td class="px-4 py-3">
                            <button onclick="markCompleted('${a.id}')" class="text-blue-500 hover:underline text-xs mr-2">Complete</button>
                            <button onclick="deleteActivity('${a.id}')" class="text-red-500 hover:underline text-xs">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function insertActivity() {
            const input = document.getElementById('new-activity-data');
            try {
                const rawData = JSON.parse(input.value);
                addLog('Inserting activity...');
                const data = await api('POST', '/api/activities', { raw_data: rawData });
                if (data.success) {
                    addLog(`Created: ${data.activity.id}`, 'success');
                    await refreshActivities();
                } else {
                    addLog(`Error: ${data.error}`, 'error');
                }
            } catch (e) {
                addLog(`Invalid JSON: ${e.message}`, 'error');
            }
        }

        async function markCompleted(id) {
            const data = await api('PATCH', `/api/activities/${id}`, { status: 'completed' });
            if (data.success) {
                addLog(`Marked ${id.slice(0, 8)} completed`, 'success');
                await refreshActivities();
            }
        }

        async function deleteActivity(id) {
            const data = await api('DELETE', `/api/activities/${id}`);
            if (data.success) {
                addLog(`Deleted ${id.slice(0, 8)}`, 'success');
                await refreshActivities();
            }
        }

        // ==================== AGENTS & WORKSPACES ====================
        async function fetchAgents() {
            addLog('Fetching agents...');
            const data = await api('GET', '/api/agents');
            const agents = data.agents || [];
            const select = document.getElementById('agent-select');
            select.innerHTML = '<option value="">Select an agent...</option>' +
                agents.map(a => `<option value="${a.slug}">${a.name}</option>`).join('');
            addLog(`Loaded ${agents.length} agents`, 'success');
        }

        async function fetchWorkspaces() {
            addLog('Fetching workspaces...');
            const data = await api('GET', '/api/workspaces');
            const workspaces = data.workspaces || [];
            const select = document.getElementById('workspace-select');
            select.innerHTML = '<option value="">Select a workspace...</option>' +
                workspaces.map(w => `<option value="${w.slug}">${w.name}</option>`).join('');
            addLog(`Loaded ${workspaces.length} workspaces`, 'success');
        }

        async function fetchThreads() {
            const wsSlug = document.getElementById('workspace-select').value;
            const select = document.getElementById('thread-select');
            select.innerHTML = '<option value="create_new">‚ûï Create New Thread</option>';
            if (!wsSlug) return;
            const data = await api('GET', `/api/workspaces/${wsSlug}/threads`);
            const threads = data.threads || [];
            select.innerHTML = '<option value="create_new">‚ûï Create New Thread</option>' +
                threads.map(t => `<option value="${t.slug}">${t.name}</option>`).join('');
            addLog(`Loaded ${threads.length} threads`);
        }

        // ==================== TRIGGER AGENT ====================
        async function triggerAgent() {
            const rawData = JSON.parse(document.getElementById('raw-data-input').value);
            const agent = document.getElementById('agent-select').value;
            const workspace = document.getElementById('workspace-select').value;
            const thread = document.getElementById('thread-select').value;
            const prompt = document.getElementById('prompt-input').value;
            const autoRun = document.getElementById('auto-run-toggle').checked;

            if (autoRun && (!agent || !workspace)) {
                addLog('ERROR: Auto mode requires agent and workspace', 'error');
                return;
            }

            addLog(`Triggering agent (${autoRun ? 'auto' : 'manual'})...`);
            const data = await api('POST', '/api/webhook/trigger', {
                raw_data: rawData,
                auto_run: autoRun,
                prompt,
                agent_name: autoRun ? agent : undefined,
                workspace_slug: autoRun ? workspace : undefined,
                thread_slug: autoRun && thread !== 'create_new' ? thread : undefined,
            });

            if (data.success) {
                addLog(`SUCCESS! Task: ${data.task_uuid}`, 'success');
                document.getElementById('task-uuid-input').value = data.task_uuid;
            } else {
                addLog(`FAILED: ${data.error}`, 'error');
            }
        }

        // ==================== TASK STATUS ====================
        async function fetchTaskStatus() {
            const uuid = document.getElementById('task-uuid-input').value.trim();
            if (!uuid) { addLog('Enter a task UUID', 'error'); return; }
            addLog(`Fetching task ${uuid.slice(0, 8)}...`);
            const data = await api('GET', `/api/tasks/${uuid}`);
            const resultDiv = document.getElementById('task-status-result');
            if (data.success && data.task) {
                document.getElementById('task-status-value').textContent = data.task.status || 'unknown';
                document.getElementById('task-source-value').textContent = data.task.sourceAppName || '-';
                resultDiv.classList.remove('hidden');
                addLog(`Task status: ${data.task.status}`, 'success');
            } else {
                resultDiv.classList.add('hidden');
                addLog(`Task not found`, 'error');
            }
        }

        // ==================== LLM: PROVIDERS ====================
        async function fetchProviders() {
            addLog('Fetching LLM chat & embedding providers separately...');

            try {
                // Fetch both types of providers in parallel using separate endpoints
                const [chatData, embedData] = await Promise.all([
                    api('GET', '/api/llm/providers/chat'),
                    api('GET', '/api/llm/providers/embed')
                ]);

                const chatSelect = document.getElementById('chat-model-select');
                const embedSelect = document.getElementById('embed-model-select');

                // Render Chat Providers
                if (chatData.success) {
                    let chatHtml = '<option value="">Auto-select (Default)</option>';
                    chatData.providers.forEach(p => {
                        chatHtml += `<optgroup label="${p.provider}">`;
                        p.models.forEach(m => {
                            chatHtml += `<option value="${p.provider}/${m.id}">${m.id}</option>`;
                        });
                        chatHtml += '</optgroup>';
                    });
                    chatSelect.innerHTML = chatHtml;
                }

                // Render Embedding Providers
                if (embedData.success) {
                    let embedHtml = '<option value="">Auto-select (Default)</option>';
                    embedData.providers.forEach(p => {
                        embedHtml += `<optgroup label="${p.provider}">`;
                        p.models.forEach(m => {
                            embedHtml += `<option value="${p.provider}/${m.id}">${m.id}</option>`;
                        });
                        embedHtml += '</optgroup>';
                    });
                    embedSelect.innerHTML = embedHtml;
                }

                addLog(`Loaded models (Chat: ${chatData.providers?.length || 0}, Embed: ${embedData.providers?.length || 0})`, 'success');
            } catch (error) {
                addLog(`Error fetching providers: ${error.message}`, 'error');
            }
        }

        // ==================== STT ====================
        async function startSTTListening() {
            const btn = document.getElementById('stt-listen-btn');
            const statusDiv = document.getElementById('stt-status');
            const provider = document.getElementById('stt-provider').value;
            const model = document.getElementById('stt-model').value || undefined;

            // Reset UI
            btn.disabled = true;
            btn.innerHTML = `<span class="animate-pulse">Listening...</span>`;
            btn.classList.replace('bg-blue-600', 'bg-red-600');
            btn.classList.replace('hover:bg-blue-500', 'hover:bg-red-500');

            statusDiv.innerHTML = `<div class="flex flex-col items-center justify-center gap-2">
                <div class="w-full max-w-[200px] h-1 bg-gray-200 rounded-full overflow-hidden">
                    <div class="h-full bg-blue-500 animate-[progress_1.5s_infinite_linear]" style="width: 50%"></div>
                </div>
                <p class="text-gray-500 text-xs">Speak now...</p>
            </div>`;

            addLog(`Starting STT (${provider})...`);

            try {
                const result = await api('POST', '/api/stt/listen', {
                    provider,
                    model,
                    timeout: 60000 // 60s timeout for browser models
                });

                btn.disabled = false;
                btn.innerHTML = 'üé§ Start Listening';
                btn.classList.replace('bg-red-600', 'bg-blue-600');
                btn.classList.replace('hover:bg-red-500', 'hover:bg-blue-500');

                if (result.success) {
                    statusDiv.innerHTML = `<p class="text-gray-800 font-medium leading-relaxed">"${result.text}"</p>`;
                    addLog(`Transcript: "${result.text}"`, 'success');
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                console.error(error);
                btn.disabled = false;
                btn.innerHTML = 'Retry Listening';
                btn.classList.replace('bg-red-600', 'bg-blue-600');
                btn.classList.replace('hover:bg-red-500', 'hover:bg-blue-500');

                statusDiv.innerHTML = `<div class="text-red-500 text-sm text-center">
                    <strong>Error:</strong><br>${error.message}
                </div>`;
                addLog(`STT Error: ${error.message}`, 'error');
            }
        }

        async function fetchSTTModels() {
            const select = document.getElementById('stt-model');
            select.innerHTML = '<option>Loading...</option>';
            select.disabled = true;

            try {
                addLog('Fetching STT models...');
                // Direct call to Node.js app wrapper route
                const result = await api('GET', '/api/stt/models');

                select.innerHTML = '';
                select.disabled = false;

                if (result.success && Array.isArray(result.models)) {
                    let totalModels = result.models.length;

                    // Group by provider for UI display
                    const modelsByProvider = {};
                    result.models.forEach(m => {
                        if (!modelsByProvider[m.provider]) {
                            modelsByProvider[m.provider] = [];
                        }
                        modelsByProvider[m.provider].push(m);
                    });

                    Object.keys(modelsByProvider).forEach(provider => {
                        const models = modelsByProvider[provider];
                        if (models.length > 0) {
                            const optgroup = document.createElement('optgroup');
                            // Capitalize provider name
                            optgroup.label = provider ? (provider.charAt(0).toUpperCase() + provider.slice(1)) : 'Other';

                            models.forEach(m => {
                                const opt = document.createElement('option');
                                opt.value = m.id;
                                opt.text = m.name;
                                if (m.recommended) opt.selected = true;
                                optgroup.appendChild(opt);
                            });
                            select.appendChild(optgroup);
                        }
                    });

                    addLog(`Loaded ${totalModels} models from ${Object.keys(modelsByProvider).length} providers.`);

                    // Select first if none recommended
                    if (select.selectedIndex === -1 && select.options.length > 0) {
                        select.options[0].selected = true;
                    }
                } else {
                    throw new Error(result.error || 'Failed to load models or invalid format');
                }
            } catch (e) {
                console.error(e);
                select.innerHTML = '<option value="">Failed to load</option>';
                addLog(`Error fetching models: ${e.message}`, 'error');
            }
        }

        // Load models initially? Or when tab is switched?
        // Let's load on init for simplicity
        setTimeout(fetchSTTModels, 1000);

        // ==================== LLM: CHAT ====================
        async function sendChat() {
            const messagesRaw = document.getElementById('chat-messages').value;
            const modelFull = document.getElementById('chat-model-select').value;
            const stream = document.getElementById('chat-stream').checked;
            const responseDiv = document.getElementById('chat-response');

            let messages;
            try {
                messages = JSON.parse(messagesRaw);
            } catch (e) {
                addLog('Invalid messages JSON', 'error');
                return;
            }

            // Parse provider/model (handles multi-slash IDs like writer/palmyra)
            let provider, model;
            if (modelFull) {
                const parts = modelFull.split('/');
                provider = parts[0];
                model = parts.slice(1).join('/');
            }

            responseDiv.classList.remove('hidden');
            responseDiv.innerHTML = '<span class="animate-pulse">Thinking...</span>';

            if (stream) {
                addLog('Starting SSE stream...');
                responseDiv.textContent = '';
                try {
                    const res = await fetch('/api/llm/chat/stream', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ messages, model, provider })
                    });

                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || 'Stream failed');
                    }

                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        for (const line of lines) {
                            if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try {
                                    const chunk = JSON.parse(line.slice(6));
                                    if (chunk.textResponse) {
                                        responseDiv.textContent += chunk.textResponse;
                                        responseDiv.scrollTop = responseDiv.scrollHeight;
                                    }
                                } catch { }
                            }
                        }
                    }
                    addLog('Stream finished', 'success');
                } catch (e) {
                    responseDiv.innerHTML = `<span class="text-red-500">Error: ${e.message}</span>`;
                    addLog(`Stream error: ${e.message}`, 'error');
                }
            } else {
                addLog('Sending sync chat...');
                const data = await api('POST', '/api/llm/chat', { messages, model, provider, response_format: { type: 'text' } });
                if (data.success) {
                    responseDiv.textContent = data.response?.content || 'No content';
                    addLog(`Chat done: ${data.response?.content?.slice(0, 20)}...`, 'success');
                } else {
                    responseDiv.innerHTML = `<span class="text-red-500">Error: ${data.error}</span>`;
                    addLog(`Chat error: ${data.error}`, 'error');
                }
            }
        }

        // ==================== LLM: EMBEDDINGS ====================
        async function generateEmbedding() {
            const input = document.getElementById('embed-input').value;
            const modelFull = document.getElementById('embed-model-select').value;
            let provider, model;
            if (modelFull) {
                const parts = modelFull.split('/');
                provider = parts[0];
                model = parts.slice(1).join('/');
            }

            addLog('Generating embedding...');
            const data = await api('POST', '/api/llm/embed', { input, provider, model });
            const resultDiv = document.getElementById('embed-result');
            resultDiv.classList.remove('hidden');
            if (data.success) {
                const vec = data.embeddings?.[0] || [];
                resultDiv.textContent = `Dimensions: ${data.dimensions}\n\nVector [0..4]:\n${JSON.stringify(vec.slice(0, 5), null, 2)}`;
                addLog(`Embedding generated (${data.dimensions}d)`, 'success');
            } else {
                resultDiv.textContent = `Error: ${data.error}`;
                addLog(`Embed error: ${data.error}`, 'error');
            }
        }

        // ==================== VECTOR STORE ====================
        async function deleteAllVectors() {
            const workspaceId = document.getElementById('vector-workspace-id').value || undefined;
            if (!confirm(`Delete all vectors${workspaceId ? ` in workspace "${workspaceId}"` : ''}?`)) return;

            addLog('Deleting vectors...');
            const data = await api('POST', '/api/llm/vectors/delete', { deleteAll: true, workspaceId });
            if (data.success) {
                addLog('Deleted successfully', 'success');
            } else {
                addLog(`Delete error: ${data.error}`, 'error');
            }
        }

        async function embedAndStore() {
            const textsRaw = document.getElementById('embed-store-texts').value;
            const texts = textsRaw.split('\n').filter(t => t.trim());
            const documentId = document.getElementById('embed-store-doc-id').value || undefined;
            const workspaceId = document.getElementById('vector-workspace-id').value || undefined;
            const modelFull = document.getElementById('embed-model-select').value;
            let provider, model;
            if (modelFull) {
                const parts = modelFull.split('/');
                provider = parts[0];
                model = parts.slice(1).join('/');
            }

            addLog(`Embedding and storing ${texts.length} texts...`);
            const data = await api('POST', '/api/llm/embed-and-store', {
                texts,
                document_id: documentId,
                workspaceId,
                provider,
                model
            });

            if (data.success) {
                addLog(`Stored ${texts.length} vectors successfully`, 'success');
                showVectorPanel('search');
            } else {
                addLog(`Store error: ${data.error}`, 'error');
            }
        }

        async function semanticSearch() {
            const query = document.getElementById('search-query').value;
            const topK = parseInt(document.getElementById('search-topk').value) || 3;
            const modelFull = document.getElementById('embed-model-select').value;
            let provider, model;
            if (modelFull) {
                const parts = modelFull.split('/');
                provider = parts[0];
                model = parts.slice(1).join('/');
            }

            const documentId = document.getElementById('search-doc-id').value || undefined;

            if (!query) return;

            addLog(`Searching: "${query.slice(0, 30)}..."...`);
            const workspaceId = document.getElementById('vector-workspace-id').value || undefined;
            const data = await api('POST', '/api/llm/search', {
                query,
                topK,
                workspaceId,
                documentId,
                provider,
                model
            });

            const resultDiv = document.getElementById('vector-result');
            resultDiv.classList.remove('hidden');
            if (data.success) {
                if (data.results && data.results.length > 0) {
                    resultDiv.innerHTML = data.results.map((r, i) => `
                        <div class="p-3 bg-blue-50 border border-blue-100 rounded-lg">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-[10px] font-bold text-blue-400 uppercase">Result #${i + 1}</span>
                                <span class="text-[10px] bg-blue-200 text-blue-700 px-1.5 py-0.5 rounded font-mono">Score: ${r.score?.toFixed(4) || 'N/A'}</span>
                            </div>
                            <p class="text-xs text-gray-700 leading-relaxed">${r.metadata.text}</p>
                            ${r.metadata ? `<div class="mt-2 text-[9px] text-gray-400 font-mono italic truncate">Meta: ${JSON.stringify(r.metadata)}</div>` : ''}
                        </div>
                    `).join('');
                    addLog(`Found ${data.results.length} results`, 'success');
                } else {
                    resultDiv.innerHTML = '<div class="p-8 text-center text-gray-400 text-sm italic">No results found. Try ingesting data first!</div>';
                }
            } else {
                resultDiv.innerHTML = `<div class="p-4 text-red-500 text-xs italic">Error: ${data.error}</div>`;
                addLog(`Search error: ${data.error}`, 'error');
            }
        }

        // ==================== VECTOR DISCOVERY ====================
        let currentProviders = [];
        let registrationProvider = null;

        async function listVectorProviders() {
            addLog('Listing vector providers...');
            const data = await api('GET', '/api/llm/vectors/providers');
            const list = document.getElementById('vector-providers-list');
            if (data.success) {
                currentProviders = data.providers;
                list.innerHTML = data.providers.map(p => `
                    <div class="p-4 border rounded-xl hover:shadow-md transition-shadow bg-white text-left group">
                        <h5 class="text-sm font-bold text-gray-800">${p.label}</h5>
                        <p class="text-[11px] text-gray-500 mb-3">${p.description}</p>
                        <button onclick="showRegistration('${p.name}')" class="text-[11px] font-bold text-blue-500 group-hover:underline">CONFIGURE &rarr;</button>
                    </div>
                `).join('');
                addLog(`Found ${data.providers.length} vector providers`, 'success');
            } else {
                addLog(`Error: ${data.error}`, 'error');
            }
        }

        function showRegistration(providerName) {
            const provider = currentProviders.find(p => p.name === providerName);
            if (!provider) return;

            registrationProvider = providerName;
            document.getElementById('reg-provider-name').textContent = provider.label;
            const fieldsDiv = document.getElementById('reg-fields');

            fieldsDiv.innerHTML = provider.fields.map(f => `
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">${f.label}</label>
                    <input type="${f.type}" id="reg-field-${f.name}" placeholder="${f.placeholder || ''}" 
                        class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition-colors">
                </div>
            `).join('');

            document.getElementById('registration-form').classList.remove('hidden');
            document.getElementById('registration-form').scrollIntoView({ behavior: 'smooth' });
        }

        // ==================== VECTOR CONFIG ====================
        async function updateVectorConfigDisplay() {
            try {
                const data = await api('GET', '/api/llm/vectors/config');
                const configDiv = document.getElementById('current-vector-db');
                if (data.success && data.provider) {
                    document.getElementById('current-db-name').textContent = data.provider;

                    // Format display details
                    let details = '';
                    if (data.provider === 'lancedb') {
                        details = `URI: ${data.config?.uri || 'Default'}`;
                    } else if (data.provider === 'pgvector') {
                        // Mask the password in connection string for security
                        let url = data.config?.databaseUrl || '';
                        if (url.includes(':') && url.includes('@')) {
                            const [prefix, rest] = url.split('://');
                            const [auth, host] = rest.split('@');
                            const [user, pass] = auth.split(':');
                            details = `${prefix}://${user}:****@${host}\nTable: ${data.config?.tableName || 'default'}`;
                        } else {
                            details = `Table: ${data.config?.tableName || 'default'}`;
                        }
                    } else if (data.config) {
                        details = Object.entries(data.config)
                            .map(([k, v]) => `${k}: ${typeof v === 'string' && v.length > 20 ? v.slice(0, 20) + '...' : v}`)
                            .join(', ');
                    }

                    document.getElementById('current-db-details').textContent = details;
                    configDiv.classList.remove('hidden');
                } else {
                    configDiv.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching vector config:', error);
            }
        }

        async function registerVectorConfig() {
            const provider = currentProviders.find(p => p.name === registrationProvider);
            if (!provider) return;

            const config = {};
            provider.fields.forEach(f => {
                config[f.name] = document.getElementById(`reg-field-${f.name}`).value;
            });

            addLog(`Registering custom config for ${provider.label}...`);
            const data = await api('POST', '/api/llm/vectors/register', { provider: registrationProvider, config });

            if (data.success) {
                addLog('Successfully registered custom storage!', 'success');
                document.getElementById('registration-form').classList.add('hidden');
                addLog('App will now use this storage for all vector operations.', 'info');
                await updateVectorConfigDisplay(); // Refresh display
            } else {
                addLog(`Registration failed: ${data.error}`, 'error');
            }
        }

        // ==================== VECTOR: WORKSPACES ====================
        async function fetchVectorWorkspaces() {
            try {
                const data = await api('GET', '/api/llm/vectors/workspaces');
                const datalist = document.getElementById('workspace-list');
                if (data.success && data.workspaces) {
                    datalist.innerHTML = '';
                    // Always allow 'default'
                    const workspaces = data.workspaces.includes('default') ? data.workspaces : ['default', ...data.workspaces];
                    workspaces.forEach(ws => {
                        const option = document.createElement('option');
                        option.value = ws;
                        datalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error fetching workspaces:', error);
            }
        }

        // ==================== TTS ====================
        let currentTTSAudioBlob = null;
        let audioPlaybackQueue = [];
        let isPlaybackPlaying = false;
        let currentPlaybackIndex = 0;

        let ttsProvidersCache = [];

        async function fetchTTSProviders() {
            addLog('Fetching TTS providers...');
            try {
                const data = await api('GET', '/api/tts/providers');
                const select = document.getElementById('tts-provider-select');

                if (data.success && data.providers) {
                    ttsProvidersCache = data.providers;
                    let html = '';
                    data.providers.forEach(p => {
                        const streaming = p.supportsStreaming ? ' (Streaming)' : '';
                        const local = p.type === 'client' ? ' [LOCAL]' : '';
                        html += `<option value="${p.id}">${p.name}${streaming}${local}</option>`;
                    });
                    select.innerHTML = html;
                    addLog(`Loaded ${data.providers.length} TTS providers`, 'success');
                    updateTTSConfigUI();
                } else {
                    select.innerHTML = '<option value="">No providers available</option>';
                    addLog('No TTS providers found', 'error');
                }
            } catch (error) {
                addLog(`Error fetching TTS providers: ${error.message}`, 'error');
                document.getElementById('tts-provider-select').innerHTML = '<option value="">Error loading providers</option>';
            }
        }

        function updateTTSConfigUI() {
            const providerId = document.getElementById('tts-provider-select').value;
            const provider = ttsProvidersCache.find(p => p.id === providerId);
            const voiceSelect = document.getElementById('tts-voice-select');
            const languageContainer = document.getElementById('tts-language-container');
            const qualityContainer = document.getElementById('tts-quality-container');
            const providerInfo = document.getElementById('tts-provider-info');

            if (!provider) return;

            // Update voice options
            if (provider.config?.voices?.length) {
                voiceSelect.innerHTML = '<option value="">Default</option>' +
                    provider.config.voices.map(v => `<option value="${v}">${v}</option>`).join('');
            } else {
                voiceSelect.innerHTML = '<option value="">Default</option>';
            }

            // Show/hide language (only for Supertonic)
            if (provider.config?.languages?.length) {
                languageContainer.classList.remove('hidden');
            } else {
                languageContainer.classList.add('hidden');
            }

            // Show/hide quality (only for Supertonic)
            if (provider.config?.quality) {
                qualityContainer.classList.remove('hidden');
            } else {
                qualityContainer.classList.add('hidden');
            }

            // Show provider info
            if (provider.note) {
                providerInfo.textContent = provider.note;
                providerInfo.classList.remove('hidden');
            } else {
                providerInfo.classList.add('hidden');
            }
        }

        async function generateTTS() {
            const text = document.getElementById('tts-text-input').value.trim();
            const provider = document.getElementById('tts-provider-select').value;
            const voice = document.getElementById('tts-voice-select').value;
            const speed = parseFloat(document.getElementById('tts-speed-range').value);
            const language = document.getElementById('tts-language-select').value;
            const num_inference_steps = parseInt(document.getElementById('tts-quality-range').value);
            const audioContainer = document.getElementById('tts-audio-container');
            const audioPlayer = document.getElementById('tts-audio-player');
            const audioInfo = document.getElementById('tts-audio-info');
            const errorDiv = document.getElementById('tts-error');

            if (!text) {
                addLog('Please enter text to speak', 'error');
                return;
            }

            addLog(`Generating speech with ${provider || 'default'} (speed: ${speed}x)...`);
            errorDiv.classList.add('hidden');
            audioContainer.classList.add('hidden');

            try {
                const body = { text, provider };
                if (voice) body.voice = voice;
                if (speed !== 1.0) body.speed = speed;
                if (language) body.language = language;
                if (num_inference_steps !== 10) body.num_inference_steps = num_inference_steps;

                const response = await fetch('/api/tts/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'TTS generation failed');
                }

                // Get audio blob
                const audioBlob = await response.blob();
                currentTTSAudioBlob = audioBlob;

                // Create object URL and set audio source
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayer.src = audioUrl;

                // Show info
                const sizeKB = (audioBlob.size / 1024).toFixed(1);
                audioInfo.textContent = `Size: ${sizeKB} KB | Type: ${audioBlob.type || 'audio/mpeg'}`;

                audioContainer.classList.remove('hidden');
                addLog(`Speech generated: ${sizeKB} KB`, 'success');

                // Auto-play
                audioPlayer.play().catch(() => { });

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                addLog(`TTS error: ${error.message}`, 'error');
            }
        }
        async function generateTTSChunked() {
            const text = document.getElementById('tts-text-input').value.trim();
            const provider = document.getElementById('tts-provider-select').value;
            const voice = document.getElementById('tts-voice-select').value;
            const speed = parseFloat(document.getElementById('tts-speed-range').value);
            const language = document.getElementById('tts-language-select').value;
            const num_inference_steps = parseInt(document.getElementById('tts-quality-range').value);

            const progressContainer = document.getElementById('tts-chunks-progress');
            const progressBar = document.getElementById('tts-chunks-bar');
            const currentCount = document.getElementById('tts-chunk-current');
            const totalCount = document.getElementById('tts-chunk-total');
            const currentText = document.getElementById('tts-chunk-text');
            const errorDiv = document.getElementById('tts-error');
            const audioContainer = document.getElementById('tts-audio-container');
            const audioPlayer = document.getElementById('tts-audio-player');

            if (!text) {
                addLog('Please enter text to speak', 'error');
                return;
            }

            addLog(`Starting chunked streaming with ${provider}...`);
            errorDiv.classList.add('hidden');
            progressContainer.classList.remove('hidden');
            audioContainer.classList.add('hidden');

            // Reset progress
            progressBar.style.width = '0%';
            currentCount.textContent = '0';
            totalCount.textContent = '0';
            currentText.textContent = 'Starting...';

            let audioChunks = [];
            let totalChunks = 0;

            // Playback state for this request
            audioPlaybackQueue = [];
            currentPlaybackIndex = 0;
            isPlaybackPlaying = false;

            audioPlayer.onended = () => {
                currentPlaybackIndex++;
                playNextChunkInQueue();
            };

            async function playNextChunkInQueue() {
                // If something is already playing, don't interrupt
                if (isPlaybackPlaying && !audioPlayer.paused && !audioPlayer.ended) return;

                if (currentPlaybackIndex >= audioPlaybackQueue.length) {
                    // We've reached the end of what we've downloaded so far
                    isPlaybackPlaying = false;
                    if (currentPlaybackIndex >= totalChunks && totalChunks > 0) {
                        addLog('Finished playing all chunks', 'success');
                    }
                    return;
                }

                const chunk = audioPlaybackQueue[currentPlaybackIndex];
                if (!chunk) {
                    isPlaybackPlaying = false;
                    return;
                }

                isPlaybackPlaying = true;
                const audioBlob = await (await fetch(`data:${chunk.mimeType || 'audio/wav'};base64,${chunk.audio}`)).blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayer.src = audioUrl;
                audioContainer.classList.remove('hidden');
                audioPlayer.play().catch(err => {
                    console.error('Playback error:', err);
                    isPlaybackPlaying = false;
                });
            }

            try {
                const body = { text, provider };
                if (voice) body.voice = voice;
                if (speed !== 1.0) body.speed = speed;
                if (language) body.language = language;
                if (num_inference_steps !== 10) body.num_inference_steps = num_inference_steps;

                const response = await fetch('/api/tts/speak/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Streaming failed');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let eventType = '';


                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (!trimmedLine) continue;

                        if (trimmedLine.startsWith('event:')) {
                            eventType = trimmedLine.slice(6).trim();
                        } else if (trimmedLine.startsWith('data:')) {
                            const data = JSON.parse(trimmedLine.slice(5).trim());

                            if (eventType === 'info') {
                                totalChunks = data.totalChunks;
                                totalCount.textContent = totalChunks;
                                addLog(`Split text into ${totalChunks} chunks`, 'info');
                            } else if (eventType === 'chunk') {
                                const index = data.index;
                                audioChunks[index] = data;
                                currentCount.textContent = index + 1;
                                currentText.textContent = data.text;
                                const percent = ((index + 1) / totalChunks) * 100;
                                progressBar.style.width = `${percent}%`;
                                addLog(`Received chunk ${index + 1}/${totalChunks}`, 'info');

                                // Add to queue and start playing if not already
                                audioPlaybackQueue[index] = data;
                                addLog(`Queued chunk ${index + 1} (${(data.audio.length / 1.33 / 1024).toFixed(1)} KB) - mime: ${data.mimeType}`, 'info');
                                if (!isPlaybackPlaying) {
                                    playNextChunkInQueue();
                                }
                            } else if (eventType === 'error') {
                                addLog(`Chunk error: ${data.error}`, 'error');
                            }
                            eventType = '';
                        }
                    }
                }

                if (audioPlaybackQueue.length > 0) {
                    addLog('Streamed audio ready', 'success');
                    // Entire stream finished, we've been playing along
                    document.getElementById('tts-audio-info').textContent = `Streamed and played ${totalChunks} chunks`;
                } else {
                    throw new Error('No audio chunks received');
                }

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                addLog(`Streaming error: ${error.message}`, 'error');
            }
        }

        function downloadTTSAudio() {
            if (!currentTTSAudioBlob) {
                addLog('No audio to download', 'error');
                return;
            }

            const url = URL.createObjectURL(currentTTSAudioBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tts_audio_${Date.now()}.mp3`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            addLog('Downloaded audio file', 'success');
        }

        // ==================== INIT ====================
        window.onload = async () => {
            await loadAppInfo();
            await refreshActivities();
            await fetchVectorWorkspaces();
            await updateVectorConfigDisplay();
            await fetchTTSProviders();
            addLog('Ready!', 'success');
        };
    </script>
</body>

</html>